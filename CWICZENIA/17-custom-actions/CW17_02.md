# Practical Exercise 23 - Using and Extending Our Composite Custom Action

## English Version

### Exercise Description

In this practical exercise, our goal is to explore how to use and how to extend our composite custom action.

In order to achieve that, we will leverage a React application that we will scaffold with the help of the `create-react-app` utility. Check the tips section for the specific command to scaffold your React application. Here are the instructions for the exercise:

1. Generate a React application:
   - a. Create a new folder named `17-custom-actions` at the root of the repository.
   - b. Using a terminal, cd into this directory and scaffold a React application inside a `react-app` directory. You can either create the directory yourself or let the `create-react-app` utility do it for you.
   - c. Once the React setup is done, you should see a success message.
   - d. Take a few moments to inspect the files and get familiar with the application folder structure.
2. Create a file named `17-1-custom-actions-composite.yaml` under the `.github/workflows` folder at the root of your repository.
3. Name the workflow `17 – 1 – Custom Actions – Composite`.
4. Add the following triggers with event filters and activity types to your workflow:
   - a. `workflow_dispatch`: the `workflow_dispatch` should also receive an input named `target-env`, of type `choice` and with the following options: `dev`, `prod`.
5. Set the `run-name` option of the workflow to `17 – 1 – Custom Actions – Composite | env – <retrieve target-env input here>`.
6. Define a top-level `env` variable named `working-directory` and with value `17-custom-actions/react-app`.
7. Add a single job named `build` to the workflow.
   - a. It should run on `ubuntu-latest`.
   - b. It should set the default `working-directory` option for run commands to the value of the `env` variable `working-directory`.
   - c. It should contain four steps:
     - i. The first step should checkout the code.
     - ii. The second step, named `Setup Node and NPM Dependencies`, should use the recently created custom action. To reference a custom action created in the same repository as the workflow, you can simply provide the path of the directory where the `action.yaml` file is located. In this case, this would be `./.github/actions/composite-cache-deps`.
         - Do not forget to provide the necessary inputs via the `with` key!
     - iii. The third step, named `Test`, should run the `npm run test` command.
     - iv. The fourth step, named `Build`, should run the `npm run build` command.
8. Commit the changes and push the code. Trigger the workflow manually from the UI and take a few moments to inspect the result of the workflow run.
9. Now let's extend our custom action to allow us to omit dev dependencies during the installation process. This can be useful when building production versions of our application, since the bundle size is much smaller.
10. Extend our `action.yaml` file for the composite action by:
    - a. Adding a third input, which should be named `target-env`, should not be required, have a description of `"dev" or "prod". Controls whether dev dependencies are installed`, and default to `dev`.
    - b. Changing the `Install dependencies` step to conditionally determine whether it should run the `npm ci` or the `npm ci --omit=dev` variation of the script based on the received `target-env` value.
    - c. Updating the cache key to include the `target-env` information in order to correctly match `dev` and `prod` caches.
11. Extend the `17-1-custom-actions.yaml` workflow to pass the `target-env` input as a parameter to the custom action.
12. Commit the changes and push the code. Trigger the workflow manually from the UI with varying parameters and take a few moments to inspect the result of the workflow run.

### Tips

**Scaffolding a React application with create-react-app**

To generate a React application with a single command, you can leverage the create-react-app utility. In order to do that, simply run the following inside the `17-custom-actions` folder:

```
npx create-react-app --template typescript react-app
```

---

## Wersja Polska

### Opis ćwiczenia

W tym ćwiczeniu praktycznym naszym celem jest poznanie sposobu użycia oraz rozszerzenia naszej złożonej akcji niestandardowej (composite custom action).

Aby to osiągnąć, wykorzystamy aplikację React, którą utworzymy za pomocą narzędzia `create-react-app`. Sprawdź sekcję **Tips**, aby poznać dokładne polecenie potrzebne do utworzenia aplikacji React. Oto instrukcje do ćwiczenia:

1. Wygeneruj aplikację React:
   - a. Utwórz nowy folder o nazwie `17-custom-actions` w głównym katalogu repozytorium.
   - b. W terminalu przejdź do tego katalogu i utwórz aplikację React w katalogu `react-app`. Możesz utworzyć katalog samodzielnie lub pozwolić narzędziu `create-react-app` zrobić to za Ciebie.
   - c. Po zakończeniu konfiguracji React powinieneś zobaczyć komunikat o sukcesie.
   - d. Poświęć chwilę na zapoznanie się z plikami i strukturą katalogu aplikacji.
2. Utwórz plik o nazwie `17-1-custom-actions-composite.yaml` w folderze `.github/workflows` w głównym katalogu repozytorium.
3. Nazwij workflow `17 – 1 – Custom Actions – Composite`.
4. Dodaj do workflow następujące wyzwalacze z filtrami zdarzeń i typami aktywności:
   - a. `workflow_dispatch`: wyzwalacz `workflow_dispatch` powinien również przyjmować wejście o nazwie `target-env`, typu `choice`, z opcjami: `dev`, `prod`.
5. Ustaw opcję `run-name` dla workflow na `17 – 1 – Custom Actions – Composite | env – <retrieve target-env input here>`.
6. Zdefiniuj zmienną najwyższego poziomu `env` o nazwie `working-directory` i wartości `17-custom-actions/react-app`.
7. Dodaj pojedyncze zadanie (job) o nazwie `build` do workflow.
   - a. Powinno działać na `ubuntu-latest`.
   - b. Powinno ustawić domyślną opcję `working-directory` dla poleceń uruchamiania na wartość zmiennej `env` o nazwie `working-directory`.
   - c. Powinno zawierać cztery kroki:
     - i. Pierwszy krok powinien klonować kod.
     - ii. Drugi krok, nazwany `Setup Node and NPM Dependencies`, powinien używać wcześniej utworzonej akcji niestandardowej. Aby odwołać się do akcji w tym samym repozytorium, wystarczy podać ścieżkę do katalogu, w którym znajduje się plik `action.yaml`. W tym przypadku będzie to `./.github/actions/composite-cache-deps`.
         - Nie zapomnij przekazać wymaganych parametrów za pomocą klucza `with`!
     - iii. Trzeci krok, nazwany `Test`, powinien uruchamiać polecenie `npm run test`.
     - iv. Czwarty krok, nazwany `Build`, powinien uruchamiać polecenie `npm run build`.
8. Zatwierdź zmiany i wypchnij kod. Uruchom workflow ręcznie z interfejsu użytkownika i poświęć chwilę, aby sprawdzić wynik działania.
9. Rozszerzmy teraz naszą akcję niestandardową tak, aby umożliwiała pomijanie zależności deweloperskich podczas procesu instalacji. Jest to przydatne przy tworzeniu wersji produkcyjnych aplikacji, ponieważ rozmiar paczki jest znacznie mniejszy.
10. Rozszerz plik `action.yaml` dla akcji złożonej poprzez:
    - a. Dodanie trzeciego wejścia o nazwie `target-env`, które nie jest wymagane, ma opis `"dev" or "prod". Controls whether dev dependencies are installed` i domyślną wartość `dev`.
    - b. Zmianę kroku `Install dependencies`, aby warunkowo określał, czy ma uruchomić `npm ci`, czy `npm ci --omit=dev`, w zależności od wartości `target-env`.
    - c. Aktualizację klucza pamięci podręcznej, aby uwzględniał informacje o `target-env`, co pozwoli poprawnie dopasować pamięć podręczną `dev` i `prod`.
11. Rozszerz workflow `17-1-custom-actions.yaml`, aby przekazywał parametr `target-env` do akcji niestandardowej.
12. Zatwierdź zmiany i wypchnij kod. Uruchom workflow ręcznie z interfejsu użytkownika, zmieniając parametry, i sprawdź wynik działania.

### Wskazówki

**Tworzenie aplikacji React za pomocą create-react-app**

Aby wygenerować aplikację React jednym poleceniem, możesz skorzystać z narzędzia `create-react-app`. W tym celu uruchom w katalogu `17-custom-actions` następujące polecenie:

```
npx create-react-app --template typescript react-app
```
