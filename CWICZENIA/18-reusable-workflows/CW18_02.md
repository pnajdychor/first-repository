# Practical Exercise 32 - Reusing Workflows from Other Repositories

## Exercise Description (Opis ćwiczenia)

### English Version

In this practical exercise, our goal is to get familiar with creating and using reusable workflows between repositories.

This exercise requires a few more setup steps, all of them outlined here. Here are the instructions for the exercise:

### 1. Setting up a Cypress E2E testing project in a new repository:

1. Create a new repository in GitHub named `github-actions-course-example-e2e`.  
   a. Mark the repository as private and provide a reasonable description.  
   b. Check the box to add a `README` file to the repository.  
   c. Scroll to the bottom and click on `Create repository`.  
   d. Clone this to your local setup using your preferred method (`https` or `ssh`). Do not clone this inside of the existing `github-actions-course` directory. Instead, clone it as a sibling folder.

2. Open the new directory in Visual Studio Code and open a terminal in the new directory.

3. Initialize an npm project with `npm init -y`.

4. Install Cypress with `npm install cypress@13.6.1 --save-dev --save-exact`.

5. Once the installation is over, run `npx cypress open` to set up Cypress.

6. A new window should show up. Click on `Continue` and then on `E2E Testing`.

7. Click on `Continue` once again, and then on `Start E2E Testing in Chrome`. A new window should show up once again.

8. On this new window, click on *Scaffold example specs*. This will generate several test files in the `github-actions-course-example-e2e` directory. Take a few minutes to inspect the files created under the `cypress/e2e` folder.

9. Go back to the window running the E2E tests, and click on any of the file names listed on the main screen. Take a few minutes to inspect how Cypress runs the tests, as well as the test results.

10. You can now close all Chrome windows, the setup is ready and we can use Cypress on the CLI.

11. Add a `.gitignore` file and ignore the `node_modules` folder.

12. Add a new entry to the scripts section of the `package.json` file:  
    a. `"test:e2e": "cypress run"`

13. Run the Cypress tests with `npm run test:e2e`.

14. To have the tests running faster, delete the folder `2-advanced-examples` and all its contents.

15. Commit and push all the changes. The Cypress setup step is done.

---

### 2. Creating the E2E workflow within the new repository:

1. Create a file named `e2e.yaml` under the `.github/workflows` folder of the `github-actions-course-example-e2e` repository.

2. Name the workflow **E2E Tests**.

3. Add the following triggers to the workflow:  
   a. `workflow_dispatch`

4. Add a single job named `e2e-tests` to the workflow.  
   a. It should run on `ubuntu-latest`.  
   b. It should contain four steps:  
      i. The first step, named *Checkout code*, should checkout the code using the appropriate third-party action.  
      ii. The second step, named *Setup node*, should use the appropriate third-party action to set up Node with a version of `'20.x'`.  
      iii. The third step, named *Install dependencies*, should install the npm dependencies with `npm ci`.  
      iv. The fourth step, named *Run E2E tests*, should run the `npm run test:e2e` command.

5. Commit the changes and push the code. Trigger the workflow manually from the UI and inspect the results.

---

### 3. Running a reusable workflow from within another repository:

1. In the original repository (`github-actions-course`):  
   a. Make sure reusable workflows can be run by enabling the `"Allow all actions and reusable workflows"` option in repository settings under **Actions > General**.  
   b. Create a file named `18-3-reusable-workflows.yaml` under `.github/workflows`.  
      i. Name the workflow **18 – 3 – Reusable Workflows**.  
      ii. Add the trigger `workflow_dispatch`.  
      iii. Add a job named `deploy` that uses the reusable workflow from `./.github/workflows/18-1-reusable-workflows.yaml`.  
      iv. Add another job named `e2e-tests` depending on `deploy`, and use the E2E reusable workflow by referencing it as:  
      `<owner>/<repository>/.github/workflows/e2e.yaml@<branch, tag, or sha commit>`.

2. In the new repository (`github-actions-course-example-e2e`):  
   a. Add a `workflow_call` trigger to the `e2e.yaml` file.  
   b. In repository settings, under **Access**, enable *"Accessible from repositories owned by the user..."*.  
   c. If the main repository (`github-actions-course`) is public, mark it as private.  
   d. Commit changes and retry the workflow.

3. Modify the `e2e.yaml` workflow in the `github-actions-course-example-e2e` repository:  
   a. Pass parameters to the checkout action:  
      - `repository: <your username>/<your new repository>`  
      - `ref: main`  
   b. Under `workflow_call`, add a `secrets` key and a secret named `access-token`.  
   c. Pass a parameter to the checkout action:  
      - `token: <retrieve access-token input or default to secrets.GITHUB_TOKEN>`

4. In the original repository (`github-actions-course`):  
   a. Create a fine-grained **Personal Access Token (PAT)**.  
      i. Go to **Settings → Developer settings → Personal access tokens → Generate new token**.  
      ii. Select `github-actions-course-example-e2e` repository and grant read access.  
      iii. Save token and store it securely.  
      iv. Create a new repository secret `GH_TOKEN` with this value.  
   b. Update `18-3-reusable-workflows.yaml` to reference the token using:  
      ```yaml
      access-token: ${{ secrets.GH_TOKEN }}
      ```

5. Commit the changes and push the code. The reusable workflow should now execute correctly!

---

### Polish Translation

W tym ćwiczeniu naszym celem jest zapoznanie się z tworzeniem i używaniem workflow wielokrotnego użytku między różnymi repozytoriami.

Ćwiczenie to wymaga kilku kroków konfiguracyjnych — wszystkie opisano poniżej.

#### 1. Konfiguracja projektu testowego Cypress E2E w nowym repozytorium:

1. Utwórz nowe repozytorium GitHub o nazwie `github-actions-course-example-e2e`.  
   a. Ustaw repozytorium jako prywatne i dodaj opis.  
   b. Zaznacz opcję dodania pliku `README`.  
   c. Kliknij `Create repository`.  
   d. Sklonuj repozytorium lokalnie za pomocą `https` lub `ssh`, ale **nie** wewnątrz `github-actions-course`, tylko obok niego.

2. Otwórz projekt w Visual Studio Code i terminal w tym katalogu.

3. Zainicjuj projekt npm poleceniem `npm init -y`.

4. Zainstaluj Cypress: `npm install cypress@13.6.1 --save-dev --save-exact`.

5. Uruchom `npx cypress open`, aby skonfigurować Cypress.

6. Kliknij `Continue`, a następnie `E2E Testing`.

7. Kliknij ponownie `Continue`, a potem `Start E2E Testing in Chrome`.

8. Kliknij *Scaffold example specs* — utworzy to pliki testowe w folderze `cypress/e2e`.

9. Uruchom testy i obejrzyj wyniki.

10. Zamknij okna Chrome, testy są gotowe.

11. Dodaj `.gitignore` i wyklucz `node_modules`.

12. W pliku `package.json` dodaj sekcję: `"test:e2e": "cypress run"`.

13. Uruchom testy: `npm run test:e2e`.

14. Usuń folder `2-advanced-examples`, aby testy działały szybciej.

15. Zatwierdź i wypchnij zmiany.

#### 2. Tworzenie workflow E2E w nowym repozytorium:

1. Utwórz plik `e2e.yaml` w `.github/workflows`.

2. Nazwij workflow **E2E Tests**.

3. Dodaj wyzwalacz `workflow_dispatch`.

4. Dodaj zadanie `e2e-tests` z czterema krokami:  
   - Checkout kodu,  
   - Instalacja Node (20.x),  
   - Instalacja zależności (`npm ci`),  
   - Uruchomienie testów (`npm run test:e2e`).

5. Zatwierdź zmiany i uruchom workflow z interfejsu GitHub.

#### 3. Uruchamianie workflow z innego repozytorium:

1. W repozytorium `github-actions-course`:  
   - Włącz opcję *Allow all actions and reusable workflows*.  
   - Utwórz plik `18-3-reusable-workflows.yaml`.  
   - Dodaj wyzwalacz `workflow_dispatch` oraz zadania `deploy` i `e2e-tests`, które używają workflow z `e2e.yaml`.

2. W repozytorium `github-actions-course-example-e2e`:  
   - Dodaj wyzwalacz `workflow_call` do pliku `e2e.yaml`.  
   - Włącz opcję *Accessible from repositories owned by the user...*.  
   - Jeśli `github-actions-course` jest publiczne — zmień na prywatne.  
   - Zatwierdź zmiany i uruchom ponownie workflow.

3. W pliku `e2e.yaml` dodaj:  
   - Parametry `repository` i `ref: main` do akcji checkout.  
   - Sekcję `secrets` z kluczem `access-token`.  
   - Dodatkowy parametr `token` odwołujący się do `secrets.GITHUB_TOKEN`.

4. W repozytorium `github-actions-course`:  
   - Utwórz token osobisty (PAT).  
   - Nadaj mu dostęp tylko do `github-actions-course-example-e2e`.  
   - Zapisz go jako sekret `GH_TOKEN`.  
   - W pliku `18-3-reusable-workflows.yaml` przekaż go jako `access-token: ${{ secrets.GH_TOKEN }}`.

5. Zatwierdź zmiany i uruchom workflow — wszystko powinno działać poprawnie!
